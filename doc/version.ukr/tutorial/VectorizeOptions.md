# Налаштування рутин при векторизації

Як використовувати опції рутини <code>vectorize</code> при створенні векторизованої рутини.

[Огляд рутини `vectorize`](Vectorize.md) розкриває призначення і базові можливості, в цьому туторіалі буде показано розширені налаштування при створенні векторизованих рутин.

### Як передавати налаштування для векторизованої рутини

Векторизувати рутину з допомогою `vectorize` можна двома способами:

- через передачу двох аргументів. В рутину передається один або два аргументи, перший з яких - скалярна рутина, а другий - аргумент `select`, котрий впливає на поведінку векторизованої рутини. Наприклад, якщо в `select` передати числове значення, то це визначить кількість аргументів для векторизованої рутини

```js
var someRoutineVector = _.vectorize( someRoutine, 2 );
```

Векторизована рутина `someRoutineVector` створена з рутини `someRoutine`, вона приймає лише два аргументи. Якщо не вказати аргумент `select`, то рутина `vectorize` встановить значення за замовчуванням - `1`.

- через передачу мапи опцій. Для векторизації рутини створюється мапа опцій, котра обов'язково містить поле `routine` - рутина для векторизації, та додатково може поміщати поля: `select`, `fieldFilter`, `bypassingFilteredOut`, `bypassingEmpty`, `vectorizingArray`, `vectorizingMapVals`, `vectorizingMapKeys`. Створена мапа опцій передається в рутину `vectorize`

```js
var option =
{
  routine : someRoutine,
}
var someRoutineVector = _.vectorize( option );
```

Приведений приклад показує як векторизувати рутину `someRoutine` з допомогою мапи опцій. Результуюча рутина `someRoutineVector` матиме налаштування за замовчуваннями.

### Опція `select`

При створенні векторизованої рутини опція `select` має першочергове значення після опції `routine`. Опція приймає числові значення, що більші або рівні `1`, при цьому встановлюється кількість аргументів, що буде приймати векторизована рутина. Якщо потрібно, щоб векторизована рутина приймала необмежену кількість аргументів в опції вказується значення `Infinity`. За замовчуванням опція має значення `1`.

Також опція `select` може мати рядкове значення, або бути масивом. Використання рядкового значення або масиву впливає на обробку векторизованою рутиною ключів в переданих мапах.

Тож, згідно опису є чотири напрями обробки вхідних даних в залежності від значення опції `select`:

- коли опція `select` має скінчене числове значення більше від `1`;
- коли опція `select` має значення `Infinity`;
- коли опція `select` має рядкове значення;
- опція `select` має значення в вигляді масиву.

Інші опції рутини працюють в поєднанні з опцією `select`, вони будуть розкриті при розгляді вказаних вище напрямів.

### Векторизація рутини коли опція `select >= 1`

Напрям включає множину варіантів векторизації. Застосування окремого визначається набором опцій:

- якщо `vectorizingArray : 0`, `vectorizingMapVals : 0`, `vectorizingMapKeys : 0` рутина залишається без змін, тобто, скалярною;
- якщо в `fieldFilter` передано рутину-фільтр, то векторизована рутина виконує операції лише для елементів, що задовільняють умовам фільтра;
- якщо `vectorizingMapKeys : 1` i `vectorizingMapVals : 1` - векторизована рутина виконує операцію для кожного ключа і кожного значення в переданій мапі. Якщо передано масив значень і опція `vectorizingArray : 1`, то операція виконується над кожним елементом масиву. При такій комбінації опцій можливо передати лише один аргумент векторизованій рутині;
- якщо `vectorizingMapKeys : 1` i `vectorizingMapVals : 0` - векторизована рутина може проводити операцію з ключами мап та елементами масивів, при цьому значення пар `ключ-значення` мапи присвоюється результату виконання дії;
- якщо `vectorizingArray : 0` i `vectorizingMapVals : 1` - векторизована рутина виконує операцію над значеннями мапи, при цьому ключі залишаються без змін;
- якщо `vectorizingArray : 1`, `select >=2`, а інші опції зкинуті - векторизована рутина виконує операції лише з елементами переданих масивів;
- у всіх інших випадках (`vectorizingArray : 1`, `select == 1`, а інші опції зкинуті) - векторизована рутина виконує операцію з окремими елементами переданого в першому аргументі масиву.

<details>
  <summary><u>Структура файлів</u></summary>

```
vectorize
   ├── Vectorize.js
   └── package.json
```

</details>

Для дослідження варіантів векторизації створіть новий файл `Vectorize.js` в директорії `Vectorize`.

<details>
    <summary><u>Код файла <code>package.json</code></u></summary>

```json    
{
  "dependencies": {
    "wTools": ""
  }
}
```

</details>

Рутина `vectorize` належить до модуля `Tools`. Скопіюйте приведений вище код в файл `package.json` та встановіть залежності з допомогою команди `npm install`. Після встановлення залежностей модуль буде готовий до роботи.

#### Приклад векторизації при `vectorizingMapKeys : 1` і `vectorizingMapVals : 1`

<details>
    <summary><u>Код файла <code>Vectorize.js</code></u></summary>

```js   
let _ = require( 'wTools' );

// scalar routine
function sum( a )
{
  return a + 5;
}

// vectorized routine
var o =
{
  routine : sum,
  vectorizingMapKeys : 1,
  vectorizingMapVals : 1,
  select : 1,
}
let sumV = _.vectorize( o );

// log examples
console.log( sumV( [ 0, 1, 2, 'a' ] ) );
console.log( sumV( { a : 'a', b : 4, c : 5 } ) );
```

</details>

Помістіть приведений вище код в файл `Vectorize.js`.

Рутину `sum`, котра повертає суму першого аргумента і числа `5`, векторизовано з опціями `vectorizingMapKeys : 1` i `vectorizingMapVals : 1`. Опція `vectorizingArray` встановлена за замовчуванням - `1`.

Такий набір опцій означає, що при виконанні операцій з масивами, рутина додасть число `5` до елементів масиву. При роботі з мапами, рутина `sumV` додаватиме число `5`, як до ключа, так і до значення.

<details>
    <summary><u>Вивід команди <code>node Vectorize.js</code></u></summary>

```
$ node Vectorize.js
[ 5, 6, 7, 'a5' ]
[Object: null prototype] { a5: 'a5', b5: 9, c5: 10 }  
```

</details>

В директорії файла `Vectorize.js` виконайте команду `node Vectorize.js`. Порівняйте вивід з приведеним.

В першому рядку виводу отримано масив в якому до кожного елемента додано `5`. В другому рядку показано вивід при передачі мапи - рутина `sumV` відповідним чином змінила пари `ключ-значення`.

#### Приклад векторизації при `vectorizingArray : 1`, `vectorizingMapKeys : 0` і `vectorizingMapVals : 0`

<details>
    <summary><u>Код файла <code>Vectorize.js</code></u></summary>

```js   
let _ = require( 'wTools' );

// scalar routine
function arr()
{
  return _.longSlice( arguments );
}

// vectorized routine
var o =
{
  routine : arr,
  vectorizingArray : 1,
  vectorizingMapKeys : 0,
  vectorizingMapVals : 0,
  select : 2,
}
let arrV = _.vectorize( o );

// log examples
console.log( arrV( [ 0, 1, 2, 'a' ], [ 1, 2, 3, 4 ] ) );
console.log( arrV( { a : 5 }, [ 1, 2, 3 ] ) );
console.log( arrV( { a : 5 }, 1 ) );
```

</details>

Замініть вміст файла `Vectorize.js` на приведений.

Рутина `longSlice`, що поміщена в рутину `arr`, копіює ділянку масиву переданого першим аргументом, що обмежена значеннями другого і третього аргументів. Оскільки обмежень не встановлено, рутина `longSlice` поверне масив створений із масиву аргументів. При такому наборі опцій рутина буде виконувати векторні операції для елементів масиву.

Запустіть виконання файла командою `node Vectorize.js`

<details>
    <summary><u>Вивід команди <code>node Vectorize.js</code></u></summary>

```
$ node Vectorize.js
[ [ 0, 1 ], [ 1, 2 ], [ 2, 3 ], [ 'a', 4 ] ]
[ [ { a: 5 }, 1 ], [ { a: 5 }, 2 ], [ { a: 5 }, 3 ] ]
[ { a: 5 }, 1 ]
```

</details>

Перший рядок виводу консолі показує, що рутина створює масив аргументів для кожної пари елементів в переданих векторах. Другий рядок показує, що за через зкинуті опції `vectorizingMap*` мапа розглядається як скалярний елемент. Мапа `{ a : 5 }` векторно об'єднана з кожним елементом масиву `[ 1, 2, 3 ]`. В третьому рядку виводу обидва аргументи поміщені в масив рутиною `longSlice`, адже, передані аргументи не являються масивами, а тому рутина `arrV` їх не векторизує.

### Векторизація рутини коли опція `select === Infinity`

Якщо опція `select === Infinity` то векторизація проходить за сценаріями, котрі описані в пункті де опція [`select >= 1`](#Векторизація-рутини-коли-опція-select-1). При цьому знімається обмеження на кількість аргументів, що передаються в векторизовану рутину.

### Векторизація рутини коли опція `select` має рядкове значення

При використанні рядкового значення векторизована рутина розглядає значення `select` як ключ для пошуку в мапі. Якщо за таким ключем в переданій мапі знайдено масив, то рутина розкладає мапу на множину мап згідно кількості елементів масиву.
